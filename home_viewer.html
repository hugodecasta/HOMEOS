<html>


<head>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Home Viewer</title>
    <style>
        .plug.on {
            background: #0f0;
        }

        .plug.off {
            background: #555;
        }

        .plug.waiting {
            opacity: 0.5
        }
    </style>
</head>

<body>

    <!--- ------------------------------------------------------------------ -->

    <div id='plugs'></div>

    <!--- ------------------------------------------------------------------ -->

    <script src='http://192.168.43.214:8000/socket.io/socket.io.js'></script>
    <script>
        class RObject {
            constructor(port, callback = () => { }) {
                this.data = null
                this.socket = io.connect('http://192.168.43.214:' + port)
                this.socket.on('put', (data) => {
                    this.data = data
                    callback(data)
                })
                this.socket.on('connect_error', (err) => {
                    this.socket.close()
                    console.log('object closed')
                })
            }
            poke(data) {
                this.socket.emit('poke')
            }
            advice(data) {
                this.socket.emit('advice', data)
            }
        }

        let to = null
        function handle_plug(device_name) {
            clearTimeout(to)
            plugs.advice({ device_name })
            state_learner.advice('learn')
            to = setTimeout(() => {
                state_learner.advice('point')
                state_learner.advice('act')
            }, 2000)
        }

        function setup_plug(name, state) {
            let html = document.getElementById(name.replace(' ', '_'))
            if (!html) {
                html = document.createElement('button')
                html.setAttribute('id', name.replace(' ', '_'))
                html.innerHTML = name
                document.getElementById('plugs').appendChild(html)
                html.addEventListener('click', () => {
                    html.setAttribute('class', 'plug waiting ' + (plugs.data[name] ? 'off' : 'on'))
                    handle_plug(name)
                })
            }
            html.setAttribute('class', 'plug ' + (state ? 'on' : 'off'))
        }

        let kinect = new RObject(8000)
        let plugs = new RObject(5985, (devices_state) => {
            for (let plug_name in devices_state) {
                setup_plug(plug_name, devices_state[plug_name])
            }
        })
        plugs.poke()

        let learning = null
        let state_learner = new RObject(9876, (data) => {
            learning = data.is_learning
        })
        state_learner.poke()

    </script>

</body>

</html>